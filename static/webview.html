<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script defer src="js/alpinejs-swipe.js"></script>
    <script defer src="js/persist.js"></script>
    <script defer src="js/alpine.js"></script>
    <title></title>
    <link href="css/bibleviewer.css" rel="stylesheet" />
  </head>
  <body
    x-data="{ darkMode: $persist(window.matchMedia('(prefers-color-scheme: dark)').matches), isSystemDarkMode: $persist(true)}"
    x-bind:class="{'dark': darkMode}"
    class="dark:text-white dark:bg-[#222222] m-0"
  >
    <main
      class="[&_button]:font-sans [&_button]:text-white [&_button]:border-none font-sans"
      x-data="myData"
      x-swipe:left.threshold.100px="chapter++; document.getElementById('contentTop').scrollIntoView()"
      x-swipe:right.threshold.100px="chapter--; document.getElementById('contentTop').scrollIntoView()"
      x-on:keyup.up.window="if(verseNumber > 1){document.getElementById('verse' + '_' + book_number + '_' + chapter + '_' + (verseNumber - 1)).scrollIntoView(); verseNumber--}"
      x-on:keyup.down.window="if(verseNumber < maxColumnLength){document.getElementById('verse' + '_' + book_number + '_' + chapter + '_' + (verseNumber + 1)).scrollIntoView() ; verseNumber++}"
    >
      <div class="sticky z-[98] top-0">
        <div
          id="topBar"
          class="!flex gap-px !justify-between bg-black max-w-screen overflow-x-auto"
        >
          <div class="!flex gap-px h-8">
            <button
              class="bg-gray-800 px-3 !py-[unset] font-bold"
              x-on:click="$dispatch('toggle-modules')"
              x-text="module"
            ></button>
            <button
              x-show="!module2"
              class="text-xl bg-gray-800 px-3 !py-[unset] flex items-center justify-center"
              x-on:click="module2 = modules.find(mod => mod.name != module).name"
            >
              <svg
                class="w-5 h-5"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 448 512"
              >
                <path
                  fill="white"
                  d="M64 80c-8.8 0-16 7.2-16 16l0 320c0 8.8 7.2 16 16 16l320 0c8.8 0 16-7.2 16-16l0-320c0-8.8-7.2-16-16-16L64 80zM0 96C0 60.7 28.7 32 64 32l320 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM200 344l0-64-64 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l64 0 0-64c0-13.3 10.7-24 24-24s24 10.7 24 24l0 64 64 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-64 0 0 64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"
                />
              </svg>
            </button>
            <button
              class="bg-gray-800 px-3 !py-[unset] font-bold"
              x-on:click="$dispatch('toggle-books')"
              x-text="`${bookstable?.find(book =>book.book_number == book_number)?.short_name||book_number}`"
            ></button>
            <button
              class="bg-gray-800 px-3 !py-[unset] font-bold"
              x-on:click="$dispatch('toggle-chapters')"
              x-text="`${chapter}:${verseNumber}`"
            ></button>
            <button
              class="bg-gray-800 px-3 !py-[unset] flex items-center justify-center"
              x-on:click="chapter--; document.getElementById('contentTop').scrollIntoView()"
              x-on:keyup.left.window="chapter--; document.getElementById('contentTop').scrollIntoView()"
            >
              <svg
                class="w-4 h-4"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 448 512"
              >
                <path
                  fill="white"
                  d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"
                />
              </svg>
            </button>
            <button
              class="bg-gray-800 px-3 !py-[unset] flex items-center justify-center"
              x-on:click="chapter++; document.getElementById('contentTop').scrollIntoView()"
              x-on:keyup.right.window="chapter++; document.getElementById('contentTop').scrollIntoView()"
            >
              <svg
                class="w-4 h-4"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 448 512"
              >
                <path
                  fill="white"
                  d="M438.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L338.8 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l306.7 0L233.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"
                />
              </svg>
            </button>
            <button class="bg-gray-800 !p-[unset]">
              <template x-if="darkMode && !isSystemDarkMode">
                <span
                  class="!py-[unset] w-full h-full px-3"
                  x-on:click="darkMode = false"
                >
                  <svg
                    class="w-4 h-4"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512"
                  >
                    <path
                      fill="white"
                      d="M448 256c0-106-86-192-192-192l0 384c106 0 192-86 192-192zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"
                    />
                  </svg>
                </span>
              </template>
              <template x-if="!darkMode && !isSystemDarkMode">
                <span
                  class="!py-[unset] w-full h-full px-3"
                  x-on:click="isSystemDarkMode = true; darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches"
                >
                  <svg
                    class="w-4 h-4"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512"
                  >
                    <path
                      fill="white"
                      d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"
                    />
                  </svg>
                </span>
              </template>
              <template x-if="isSystemDarkMode">
                <span
                  class="!py-[unset] w-full h-full px-3"
                  x-on:click="isSystemDarkMode = false; darkMode = true"
                >
                  <svg
                    class="h-4 w-4"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 576 512"
                  >
                    <path
                      fill="white"
                      d="M64 0C28.7 0 0 28.7 0 64L0 352c0 35.3 28.7 64 64 64l176 0-10.7 32L160 448c-17.7 0-32 14.3-32 32s14.3 32 32 32l256 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-69.3 0L336 416l176 0c35.3 0 64-28.7 64-64l0-288c0-35.3-28.7-64-64-64L64 0zM512 64l0 224L64 288 64 64l448 0z"
                    />
                  </svg>
                </span>
              </template>
            </button>
          </div>
          <template x-if="module2">
            <div class="!flex gap-px h-8">
              <button
                class="bg-gray-800 px-3 !py-[unset] font-bold"
                x-on:click="$dispatch('toggle-modules2')"
                x-text="module2"
              ></button>
              <button
                class="bg-gray-800 px-3 !py-[unset] flex items-center justify-center"
                x-on:click="module2 = ''"
              >
                <svg
                  class="w-4 h-4"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 384 512"
                >
                  <path
                    fill="white"
                    d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"
                  />
                </svg>
              </button>
              <button
                class="bg-gray-800 !py-[unset] px-3 font-bold"
                x-on:click="$dispatch('toggle-books2')"
                x-text="`${bookstable2?.find(book =>book.book_number == book_number)?.short_name||book_number}`"
              ></button>
            </div>
          </template>
        </div>
        <div
          x-data="{booksopened: false}"
          x-on:toggle-books.window="booksopened = !booksopened"
          x-on:module-changed.window="bookstable = await getBooks(module)"
          class="absolute z-[900]"
          x-show="booksopened"
          x-cloak
        >
          <div
            x-on:click.outside="booksopened = false"
            x-on:keyup.escape.window="booksopened = false"
            x-on:click="$dispatch('book-changed')"
            class="mt-2 mx-3 grid gap-px bg-black max-w-full max-h-[calc(100vh-3rem)] grid-cols-6 overflow-y-auto"
            x-bind:style="`height: ${Math.ceil(bookstable.length/6) * 2}rem`"
          >
            <template x-for="book in bookstable" x-key="book.book_number">
              <button
                class="border font-bold text-nowrap bg-gray-800"
                x-bind:style="`color: ${book.book_color}`"
                x-text="book.short_name"
                x-on:click="book_number = book.book_number; booksopened = false"
              ></button>
            </template>
          </div>
        </div>
        <div
          x-data="{books2opened: false}"
          x-on:toggle-books2.window="books2opened = !books2opened"
          x-on:module2-changed.window="bookstable2 = module2 ? await getBooks(module2) : []"
          class="absolute z-[900]"
          x-show="books2opened"
          x-cloak
        >
          <div
            x-on:click.outside="books2opened = false"
            x-on:keyup.escape.window="books2opened = false"
            x-on:click="$dispatch('book-changed')"
            class="mx-3 mt-2 bg-black grid grid-cols-6 max-w-full max-h-[calc(100vh-3rem)] gap-px overflow-y-auto"
            x-bind:style="`height: ${Math.ceil(bookstable2.length/6) * 2}rem`"
          >
            <template x-for="book in bookstable2" x-key="book.book_number">
              <button
                class="border text-nowrap bg-gray-800"
                x-bind:style="`color: ${book.book_color}`"
                x-text="book.short_name"
                x-on:click="book_number = book.book_number; books2opened = false"
              ></button>
            </template>
          </div>
        </div>
        <div
          x-data="{chaptersopened: false}"
          x-on:toggle-chapters.window="chaptersopened = !chaptersopened"
          class="absolute z-[900]"
          x-show="chaptersopened"
          x-cloak
        >
          <div
            x-on:click.outside="chaptersopened = false"
            x-on:keyup.escape.window="chaptersopened = false"
            class="mx-3 mt-2 grid gap-px bg-black max-h-[calc(100vh-3rem)] max-w-full overflow-y-auto"
            x-bind:style="`grid-template-columns: repeat(${chaptercolumns}, minmax(0, 1fr)); width: ${chaptercolumns*3}rem`"
          >
            <template x-for="chap in maxchapter" x-key="chap">
              <button
                class="font-bold text-nowrap aspect-square text-white bg-gray-600"
                x-bind:class="chap == chapter ? 'bg-gray-600': 'bg-gray-800'"
                x-text="chap"
                x-on:click="chapter = chap; chaptersopened = false"
              ></button>
            </template>
          </div>
        </div>
        <div
          x-data="{modulesmenuopened: false,}"
          x-on:toggle-modules.window="modulesmenuopened = !modulesmenuopened"
          class="absolute z-[900]"
          x-show="modulesmenuopened"
          x-cloak
        >
          <div
            x-on:click.outside="modulesmenuopened = false"
            x-on:keyup.escape.window="modulesmenuopened = false"
            class="mx-3 mt-2 max-h-[calc(100vh-3rem)] max-w-full grid grid-cols-1 bg-black gap-px overflow-y-auto"
            x-bind:style="`height: ${(modules.length +1 ) * 2}rem`"
          >
            <template x-for="singlemodule in modules" x-key="singlemodule.name">
              <button
                class="flex items-center px-3 text-left bg-gray-800"
                x-show="singlemodule.name != module && singlemodule.name != module2"
                x-on:click="module = singlemodule.name ; modulesmenuopened = false"
              >
                <span class="!w-20" x-text="singlemodule.name"></span>
                <span x-text="singlemodule.description"></span>
              </button>
            </template>
          </div>
        </div>
        <div
          x-data="{modules2menuopened: false}"
          x-on:toggle-modules2.window="modules2menuopened = !modules2menuopened"
          class="absolute z-[900]"
          id="modules2"
          x-show="modules2menuopened"
          x-cloak
        >
          <div
            x-on:click.outside="modules2menuopened = false"
            x-on:keyup.escape.window="modules2menuopened = false"
            class="mx-3 mt-2 grid grid-cols-1 gap-px bg-black max-w-full max-h-[calc(100vh-3rem)] overflow-y-auto"
            x-bind:style="`height: ${(modules.length +1) * 2}rem`"
          >
            <template
              x-for="singlemodule in modules"
              x-key="singlemodule.name + '-2'"
            >
              <button
                class="flex items-center px-3 text-left bg-gray-800"
                x-show="singlemodule.name != module && singlemodule.name != module2"
                x-on:click="module2 = singlemodule.name ; modules2menuopened = false"
              >
                <span class="!w-20" x-text="singlemodule.name"></span>
                <span x-text="singlemodule.description"></span>
              </button>
            </template>
          </div>
        </div>

        <section
          id="bible"
          class="h-[calc(100vh-2rem)] overflow-y-auto px-3 text-xl [&_t]:block [&_t]:ms-[5%] [&_e]:font-bold [&_m]:hidden [&_s]:hidden [&_j]:dark:text-red-500 [&_j]:text-red-800 [&_j]:!inline"
          x-on:scroll="const box = document.getElementById('verse' + '_' + book_number + '_' + chapter + '_' + verseNumber).getBoundingClientRect(); if (box.top - topbarBottom > 0 && verseNumber > 1) verseNumber--; if (box.bottom - topbarBottom < 0 && maxColumnLength > verseNumber ) verseNumber++ "
        >
          <div id="contentTop"></div>
          <template x-for="verse in maxColumnLength" x-key="verse">
            <div
              class="grid gap-2 !text-nowrap"
              x-bind:id="'verse' + '_' + book_number + '_' + chapter + '_' + verse"
              x-bind:class="{'grid-cols-2': module2, 'grid-cols-1': !module2}"
            >
              <span>
                <span
                  class="float-left text-nowrap text-green-700 dark:text-green-500"
                  x-text="verse + '&nbsp;'"
                ></span>
                <template x-if="firstColumn[verse - 1]">
                  <span
                    class="text-wrap"
                    x-html="firstColumn[verse - 1]"
                  ></span>
                </template>
              </span>
              <template x-if="module2">
                <span>
                  <template x-if="secondColumn[verse - 1]">
                    <span
                      class="text-wrap"
                      x-html="secondColumn[verse - 1]"
                    ></span>
                  </template>
                  <template x-if="!secondColumn[verse - 1]">
                    <span></span>
                  </template>
                </span>
              </template>
            </div>
          </template>
          <div class="min-h-screen"></div>
        </section>
      </div>
      <div
        x-on:changed.window="loadColumn(module, 'firstColumn'); loadColumn(module2, 'secondColumn')"
        x-init="loadColumn(module, 'firstColumn'); loadColumn(module2, 'secondColumn')"
      ></div>
    </main>
    <script>
      let lastVerseNumber = 0;
      const topbarBottom = document
        .getElementById("topBar")
        .getBoundingClientRect().bottom;
      document.addEventListener("alpine:init", () => {
        Alpine.data("myData", () => ({
          module: Alpine.$persist("OGB"),
          module2: Alpine.$persist(""),
          book_number: Alpine.$persist(470),
          chapter: Alpine.$persist(1),
          verseNumber: Alpine.$persist(1),
          firstColumn: [],
          secondColumn: [],
          maxColumnLength: 0,
          bookstable: [],
          bookstable2: [],
          modules: [],
          maxchapter: 1,
          chaptercolumns: 6,
          max_chapters: {
            10: 50,
            20: 40,
            30: 27,
            40: 36,
            50: 34,
            60: 24,
            70: 21,
            80: 4,
            90: 31,
            100: 24,
            110: 22,
            120: 25,
            130: 29,
            140: 36,
            150: 10,
            160: 5,
            190: 5,
            220: 43,
            230: 150,
            240: 31,
            250: 5,
            260: 8,
            290: 66,
            300: 52,
            310: 5,
            330: 48,
            340: 14,
            350: 14,
            360: 4,
            370: 9,
            380: 1,
            390: 4,
            400: 7,
            410: 3,
            420: 3,
            430: 3,
            440: 2,
            450: 14,
            460: 4,
            470: 28,
            480: 16,
            490: 24,
            500: 21,
            510: 28,
            520: 16,
            530: 16,
            540: 13,
            550: 6,
            560: 6,
            570: 4,
            580: 4,
            590: 5,
            600: 3,
            610: 6,
            620: 4,
            630: 3,
            640: 1,
            650: 13,
            660: 5,
            670: 5,
            680: 3,
            690: 5,
            700: 1,
            710: 1,
            720: 1,
            730: 22,
          },
          chapters: Alpine.$persist({
            10: 1,
            20: 1,
            30: 1,
            40: 1,
            50: 1,
            60: 1,
            70: 1,
            80: 1,
            90: 1,
            100: 1,
            110: 1,
            120: 1,
            130: 1,
            140: 1,
            150: 1,
            160: 1,
            190: 1,
            220: 1,
            230: 1,
            240: 1,
            250: 1,
            260: 1,
            290: 1,
            300: 1,
            310: 1,
            330: 1,
            340: 1,
            350: 1,
            360: 1,
            370: 1,
            380: 1,
            390: 1,
            400: 1,
            410: 1,
            420: 1,
            430: 1,
            440: 1,
            450: 1,
            460: 1,
            470: 1,
            480: 1,
            490: 1,
            500: 1,
            510: 1,
            520: 1,
            530: 1,
            540: 1,
            550: 1,
            560: 1,
            570: 1,
            580: 1,
            590: 1,
            600: 1,
            610: 1,
            620: 1,
            630: 1,
            640: 1,
            650: 1,
            660: 1,
            670: 1,
            680: 1,
            690: 1,
            700: 1,
            710: 1,
            720: 1,
            730: 1,
          }),
          verses: Alpine.$persist({
            10: 1,
            20: 1,
            30: 1,
            40: 1,
            50: 1,
            60: 1,
            70: 1,
            80: 1,
            90: 1,
            100: 1,
            110: 1,
            120: 1,
            130: 1,
            140: 1,
            150: 1,
            160: 1,
            190: 1,
            220: 1,
            230: 1,
            240: 1,
            250: 1,
            260: 1,
            290: 1,
            300: 1,
            310: 1,
            330: 1,
            340: 1,
            350: 1,
            360: 1,
            370: 1,
            380: 1,
            390: 1,
            400: 1,
            410: 1,
            420: 1,
            430: 1,
            440: 1,
            450: 1,
            460: 1,
            470: 1,
            480: 1,
            490: 1,
            500: 1,
            510: 1,
            520: 1,
            530: 1,
            540: 1,
            550: 1,
            560: 1,
            570: 1,
            580: 1,
            590: 1,
            600: 1,
            610: 1,
            620: 1,
            630: 1,
            640: 1,
            650: 1,
            660: 1,
            670: 1,
            680: 1,
            690: 1,
            700: 1,
            710: 1,
            720: 1,
            730: 1,
          }),
          getSquareColumns(maxItems) {
            const squareRoot = Math.sqrt(maxItems);

            const columns = Math.floor(squareRoot);

            if (columns * columns === maxItems) {
              return columns;
            }

            return columns + 1;
          },
          scrollIntoVerse(verse) {
            const id =
              "verse" +
              "_" +
              this.book_number +
              "_" +
              this.chapter +
              "_" +
              verse;
            this.$nextTick(() => {
              document.getElementById(id).scrollIntoView();
            });
          },
          loadColumn(module, columnName) {
            if (module)
              getChapters(module, this.book_number, this.chapter)
                .then((response) => {
                  this[columnName] =
                    response.map((item) => {
                      return item.replace(
                        /([^><]+)<S>(\d+)<\/S>/g,
                        "<span @click='console.log(`$2`)'>$1</span>",
                      );
                    }) || [];
                })
                .catch((error) => {
                  console.error("Error loading column:", error);
                  return [];
                });
          },
          init() {
            getModules().then((response) => {
              this.modules = response;
            });
            this.$dispatch("getbooks");
            this.$dispatch("getbooks2");

            this.$watch("modules", (value, oldValue) => {
              if (oldValue.length == 0) {
                this.$dispatch("module-changed");
              }
            });
            this.$watch("firstColumn", (value, oldValue) => {
              if (oldValue.length == 0) {
                this.scrollIntoVerse(this.verseNumber);
              }
            });
            this.$watch("chapter", (value, oldValue) => {
              this.verseNumber = 1;
              if (this.max_chapters[this.book_number] < value || value < 1) {
                this.chapter = oldValue;
              } else {
                this.chapters[this.book_number] = value;
                this.books = this.books;
                this.$dispatch("changed");
              }
            });
            this.$watch("module", () => {
              this.$dispatch("module-changed");
              this.$dispatch("changed");
            });
            this.$watch("module2", () => {
              this.$dispatch("module2-changed");
              this.scrollIntoVerse(this.verseNumber);
              this.$dispatch("changed");
            });
            this.$watch("book_number", (value, oldValue) => {
              this.chapter = this.chapters[value];
              const verse = this.verses[value];
              this.scrollIntoVerse(verse);
              this.maxchapter = this.max_chapters[value];
              this.chaptercolumns = this.getSquareColumns(this.maxchapter);
              this.$dispatch("changed");
              this.$dispatch("book-changed");
            });
            Alpine.effect(() => {
              if (this.modules.length) {
                this.$dispatch("modules-changed");
              }
            });
            Alpine.effect(() => {
              this.maxColumnLength = Math.max(
                this.firstColumn.length || 0,
                this.secondColumn.length || 0,
              );
            });
            this.maxchapter = this.max_chapters[this.book_number];
            this.chaptercolumns = this.getSquareColumns(this.maxchapter);

            setInterval(() => {
              if (this.verseNumber != lastVerseNumber) {
                lastVerseNumber = this.verseNumber;
                this.verses[this.book_number] = this.verseNumber;
              }
            }, 5000);
          },
        }));
      });
    </script>
  </body>
</html>
